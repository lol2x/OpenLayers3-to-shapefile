/*! openlayers2shp - v0.0.1 - 2016-01-13
* Copyright (c) 2016; Licensed   */
var ol2shp={version:"0.0.1"},Shapefile=function(){String.prototype.lpad=function(a,b){for(var c=this;c.length<b;)c=a+c;return c},String.prototype.rpad=function(a,b){for(var c=this;c.length<b;)c+=a;return c};var a=function(){this._pointgraphics=[],this._polylinegraphics=[],this._polygongraphics=[]};return a.prototype=function(){function b(a){for(var b=a.getFeatures(),c=0;c<b.length;c++){var d=b[c],e={attributes:d.getProperties(),geometry:{}};if("Point"===d.getGeometry().getType()){e.geometry.type="POINT";var f=d.getGeometry().getCoordinates();e.geometry.x=f[0],e.geometry.y=f[1],this._pointgraphics.push(e)}else"LineString"===d.getGeometry().getType()?(e.geometry.type="POLYLINE",e.geometry.paths=[d.getGeometry().getCoordinates()],this._polylinegraphics.push(e)):"Polygon"===d.getGeometry().getType()&&(e.geometry.type="POLYGON",e.geometry.rings=d.getGeometry().getCoordinates(!1),this._polygongraphics.push(e))}}var c={POINT:1,POLYLINE:3,POLYGON:5},d=function(a){if("undefined"==typeof a&&"POINT"!==a&&"POLYLINE"!==a&&"POLYGON"!==a)return{successful:!1,message:"Unknown or unspecified shapefile type requested"};var b;if("POINT"===a)b=this._pointgraphics;else if("POLYLINE"===a)b=this._polylinegraphics;else{if("POLYGON"!==a)return{successful:!1,message:"No graphics of type "+a+" have been added!"};b=this._polygongraphics}var c=e(a,b),d=i.apply(this,[b]);return c.dbf=f.apply(this,[d,b]),{successful:!0,shapefile:{shp:c.shape,shx:c.shx,dbf:c.dbf}}},e=function(a,b){var d,e,f,g,h,i=new Blob([]),j=new Blob([]),k=new ArrayBuffer(100),l=new ArrayBuffer(100);for(d=0;100>d;d++)k[d]=0,l[d]=0;var m=new DataView(k),n=new DataView(l);m.setInt32(0,9994),n.setInt32(0,9994),m.setInt32(28,1e3,!0),n.setInt32(28,1e3,!0),m.setInt32(32,c[a],!0),n.setInt32(32,c[a],!0);var o=Number.MAX_VALUE,p=Number.MAX_VALUE,q=-Number.MAX_VALUE,r=-Number.MAX_VALUE,s=b.length,t=100,u=8;switch(a){case"POINT":var v=20;for(h=v+u,d=1;s+1>d;d++){g=b[d-1];var w=g.geometry.x,x=g.geometry.y;o>w&&(o=w),w>q&&(q=w),p>x&&(p=x),x>r&&(r=x);var y=new ArrayBuffer(h),z=new DataView(y);z.setInt32(0,d),z.setInt32(4,v/2),z.setInt32(8,c[a],!0),z.setFloat64(12,w,!0),z.setFloat64(20,x,!0);var A=new ArrayBuffer(8),B=new DataView(A);B.setInt32(0,t/2),B.setInt32(4,v/2),t+=h,i=new Blob([i,z]),j=new Blob([j,B])}break;case"POLYLINE":case"POLYGON":for(d=1;s+1>d;d++){g=b[d-1];var C,D=Number.MAX_VALUE,E=Number.MAX_VALUE,F=-Number.MAX_VALUE,G=-Number.MAX_VALUE;"POLYLINE"===a?C=g.geometry.paths.length:"POLYGON"===a&&(C=g.geometry.rings.length);var H=[],I=[];for(f=0;C>f;f++){var J;"POLYLINE"===a?J=g.geometry.paths[f]:"POLYGON"===a&&(J=g.geometry.rings[f]);var K=J.length;for(H.push(I.length),e=0;K>e;e++)I.push(J[e])}var L=I.length,M=new ArrayBuffer(16*L),N=new DataView(M);for(e=0;L>e;e+=1){var O=I[e];N.setFloat64(16*e,O[0],!0),N.setFloat64(16*e+8,O[1],!0),O[0]<D&&(D=O[0]),O[0]>F&&(F=O[0]),O[1]<E&&(E=O[1]),O[1]>G&&(G=O[1])}var P=52+4*C;h=P+16*L;var Q=h-8,R=new ArrayBuffer(P),S=new DataView(R);for(S.setInt32(0,d),S.setInt32(4,Q/2),S.setInt32(8,c[a],!0),S.setFloat64(12,D,!0),S.setFloat64(20,E,!0),S.setFloat64(28,F,!0),S.setFloat64(36,G,!0),S.setInt32(44,C,!0),S.setInt32(48,L,!0),f=0;f<H.length;f++)S.setInt32(52+4*f,H[f],!0);var T=new ArrayBuffer(8),U=new DataView(T);U.setInt32(0,t/2),U.setInt32(4,Q/2),i=new Blob([i,S,N]),j=new Blob([j,U]),F>q&&(q=F),o>D&&(o=D),G>r&&(r=G),p>E&&(p=E),t+=h}break;default:return{successful:!1,message:"unknown shape type specified"}}m.setFloat64(36,o,!0),m.setFloat64(44,p,!0),m.setFloat64(52,q,!0),m.setFloat64(60,r,!0),n.setFloat64(36,o,!0),n.setFloat64(44,p,!0),n.setFloat64(52,q,!0),n.setFloat64(60,r,!0),m.setInt32(24,t/2),n.setInt32(24,50+4*s);var V=new Blob([m,i]),W=new Blob([n,j]);return{successful:!0,shape:V,shx:W}},f=function(a,b){0===a.length&&a.push({name:"ID_AUTO",type:"N",length:"8"});var c=g(a,b.length),d=c.recordLength,e=c.dbfHeader,f=h(a,b,d);return new Blob([e,f])},g=function(a,b){for(var c=a.length,d=32*c+1,e=new ArrayBuffer(d),f=new DataView(e),g=[],h=1,i=0;c>i;i++){var j=a[i].name.slice(0,10);-1===g.indexOf(j)&&g.push(j);for(var k=0;k<j.length;k++)f.setInt8(32*i+k,j.charCodeAt(k));var l,m=a[i].type||"C";if("L"===m?l=1:"D"===m?l=8:"N"===m?l=a[i].length&&a[i].length<19?a[i].length:18:"C"===m&&(l=a[i].length&&a[i].length<254?a[i].length:254),f.setInt8(32*i+11,m.charCodeAt(0)),f.setInt8(32*i+16,l),"N"===m){var n=a[i].scale||0;f.setInt8(32*i+17,n)}a[i].length=parseInt(l),h+=parseInt(l)}f.setInt8(d-1,13);var o=new ArrayBuffer(32),p=new DataView(o);p.setUint8(0,3);var q=new Date;p.setUint8(1,q.getFullYear()-1900),p.setUint8(2,q.getMonth()),p.setUint8(3,q.getDate()),p.setUint32(4,b,!0);var r=d+31+1;p.setUint16(8,r,!0),p.setUint16(10,h,!0);var s=new Blob([p,f]);return{recordLength:h,dbfHeader:s}},h=function(a,b,c){for(var d,e,f=c*b.length+1,g=new ArrayBuffer(f),h=new DataView(g),i=0,j=0;j<b.length;j++){var k=b[j].attributes||{};h.setUint8(i,32),i+=1;for(var l=0;l<a.length;l++){var m=a[l],n=m.name,o=m.type||"C",p=parseInt(m.length)||0,q=k[n]||j.toString();if("L"===o)p=1,q?h.setUint8(i,84):h.setUint8(i,70),i+=1;else if("D"===o)for(p=8,d=q.toString(),d.length!==p&&(d="".lpad(" ",8)),e=0;p>e;e++)h.setUint8(i,d.charCodeAt(e)),i+=1;else if("N"===o){if(d=q.toString(),0===p)continue;for(d.length<p?d=d.lpad(" ",p):d.length>p&&(d=d.substr(0,18)),e=0;p>e;e++)h.setUint8(i,d.charCodeAt(e)),i+=1}else if("C"===o||""===o){if(0===p)continue;for("string"!=typeof q&&(q=q.toString()),q.length<p&&(q=q.rpad(" ",p)),e=0;p>e;e++)h.setUint8(i,q.charCodeAt(e)),i+=1}}}return h.setUint8(f-1,26),new Blob([h])},i=function(a){for(var b={},c=0;c<a.length;c++){var d=a[c];if(d.attributes)for(var e in d.attributes)if(d.attributes.hasOwnProperty(e)){var f=d.attributes[e];if(b.hasOwnProperty(e))b[e].length<f.toString().length&&(b[e].length=f.toString().length);else switch(typeof f){case"number":if(parseInt(f)===f)b[e]={type:"N",length:f.toString().length};else if(parseFloat(f)===f){var g=f.toString().length-(f.toString().split(".")[0].length+1);b[e]={type:"N",length:f.toString().length,scale:g}}break;case"boolean":b[e]={type:"L"};break;case"string":b[e]={type:"C",length:f.length}}}}var h=[];for(var i in b)if(b.hasOwnProperty(i)){var j={name:i,type:b[i].type,length:b[i].length};b[i].hasOwnProperty("length")&&(j.length=b[i].length),b[i].hasOwnProperty("scale")&&(j.scale=b[i].scale),h.push(j)}return h};return{constructor:a,getOpenLayers3Geometry:function(){return b.call(this,arguments[0])},getShapefile:function(){return d.call(this,arguments[0])}}}(),a}();